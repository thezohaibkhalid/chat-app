deploy:
  runs-on: ubuntu-latest
  needs: build_and_push
  steps:
    - name: Deploy on VM
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_KEY }}
        script_stop: true
        envs: APP_NAME,DOCKER_IMAGE,IMAGE_TAG
        script: |
          set -euo pipefail
          APP_NAME="${APP_NAME:-chat-frontend}"
          DOCKER_IMAGE="${DOCKER_IMAGE:-${{ secrets.DOCKERHUB_USERNAME }}/chat-frontend}"
          IMAGE_TAG="${IMAGE_TAG:-${{ github.sha }}}"
          LIVE="${APP_NAME}"
          NEW="${APP_NAME}-new"
          PORT_LIVE=5000

          if ! command -v docker >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get remove -y containerd.io || true
            sudo apt-get install -y docker.io docker-compose-plugin
            sudo systemctl enable --now docker
          fi

          docker pull "${DOCKER_IMAGE}:${IMAGE_TAG}" || true
          docker pull "${DOCKER_IMAGE}:latest" || true
          if docker image inspect "${DOCKER_IMAGE}:${IMAGE_TAG}" >/dev/null 2>&1; then IMG="${DOCKER_IMAGE}:${IMAGE_TAG}"; else IMG="${DOCKER_IMAGE}:latest"; fi

          for p in 5001 5002 5003 5004 5005; do
            docker ps --filter "publish=${p}" -q | xargs -r docker rm -f || true
            if ! ss -tlpn | grep -E "LISTEN.+:${p}\b" >/dev/null 2>&1; then
              PORT_NEW="$p"
              break
            fi
          done
          if [ -z "${PORT_NEW:-}" ]; then
            echo "No free blue/green port found (5001-5005)"; exit 1
          fi

          docker rm -f "${NEW}" 2>/dev/null || true
          docker run -d --name "${NEW}" \
            -p 127.0.0.1:${PORT_NEW}:5000 \
            --restart always \
            "${IMG}"

          for i in $(seq 1 30); do
            if curl -fsS "http://127.0.0.1:${PORT_NEW}/" >/dev/null; then break; fi
            sleep 2
          done
          curl -fsS "http://127.0.0.1:${PORT_NEW}/" >/dev/null

          docker ps --filter "publish=${PORT_LIVE}" -q | xargs -r docker rm -f || true
          docker rm -f "${LIVE}" 2>/dev/null || true

          docker run -d --name "${LIVE}" \
            -p 127.0.0.1:${PORT_LIVE}:5000 \
            --restart always \
            "${IMG}"

          docker rm -f "${NEW}" 2>/dev/null || true
          docker image prune -f || true
