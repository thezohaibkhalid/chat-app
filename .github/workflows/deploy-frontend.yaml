name: Deploy Frontend to VM

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yaml'
  workflow_dispatch:

env:
  REPO_URL: https://github.com/thezohaibkhalid/chat-app
  REPO_NAME: chat-app
  APP_NAME: chat-frontend
  IMAGE_TAG: ${{ github.sha }}
  PORT_NEW: 5001
  PORT_LIVE: 5000
  VITE_STEAM_API_KEY: ${{ secrets.VITE_STEAM_API_KEY }}
  VITE_BASE_URL: ${{ secrets.VITE_BASE_URL }}
  NODE_ENV: ${{ secrets.NODE_ENV }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          envs: REPO_URL,REPO_NAME,APP_NAME,IMAGE_TAG,PORT_NEW,PORT_LIVE,VITE_STEAM_API_KEY,VITE_BASE_URL,NODE_ENV,GITHUB_SHA
          script: |
            set -euo pipefail

            WORKDIR="/opt/chat-frontend"
            REPO_DIR="${WORKDIR}/${REPO_NAME}"
            BUILD_CTX="${REPO_DIR}/frontend"
            DOCKERFILE="${BUILD_CTX}/Dockerfile"
            NEW="${APP_NAME}-new"
            LIVE="${APP_NAME}"
            HEALTH_URL="http://127.0.0.1:${PORT_NEW}/"

            sudo apt-get update -y
            sudo apt-get install -y git docker.io docker-compose-plugin
            sudo systemctl enable --now docker || true

            mkdir -p "${WORKDIR}"
            if [ -d "${REPO_DIR}/.git" ]; then
              cd "${REPO_DIR}"
              git fetch --all --prune
            else
              cd "${WORKDIR}"
              git clone "${REPO_URL}" "${REPO_NAME}"
              cd "${REPO_DIR}"
            fi

            git checkout -qf "${GITHUB_SHA}" || { git checkout main && git pull --ff-only && git checkout -qf "${GITHUB_SHA}"; }

            cd "${BUILD_CTX}"
            printf "VITE_STEAM_API_KEY=%s\nVITE_BASE_URL=%s\nNODE_ENV=%s\n" \
              "${VITE_STEAM_API_KEY}" "${VITE_BASE_URL}" "${NODE_ENV}" > .env

            docker build --pull -t "${APP_NAME}:${IMAGE_TAG}" -f "${DOCKERFILE}" "${BUILD_CTX}"

            docker rm -f "${NEW}" 2>/dev/null || true
            docker run -d --name "${NEW}" \
              --env-file "${BUILD_CTX}/.env" \
              -p 127.0.0.1:${PORT_NEW}:5000 \
              --restart always \
              "${APP_NAME}:${IMAGE_TAG}"

            for i in $(seq 1 30); do
              if curl -fsS "${HEALTH_URL}" >/dev/null; then break; fi
              sleep 2
            done
            curl -fsS "${HEALTH_URL}" >/dev/null

            INUSE=$(docker ps -q --filter "publish=${PORT_LIVE}") || true
            if [ -n "${INUSE}" ]; then docker rm -f ${INUSE} || true; fi
            for i in $(seq 1 10); do
              if [ -z "$(docker ps -q --filter "publish=${PORT_LIVE}")" ]; then break; fi
              sleep 1
            done

            docker rm -f "${LIVE}" 2>/dev/null || true
            docker run -d --name "${LIVE}" \
              --env-file "${BUILD_CTX}/.env" \
              -p 127.0.0.1:${PORT_LIVE}:5000 \
              --restart always \
              "${APP_NAME}:${IMAGE_TAG}"

            docker rm -f "${NEW}" 2>/dev/null || true
            docker image prune -f || true
